name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # ==========================================
  # JOB 1: Validate Version
  # ==========================================
  validate:
    name: âœ… Validate Release
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_name: ${{ steps.get_version.outputs.version_name }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_name=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: ðŸ” Validate version format
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: v1.2.3"
            exit 1
          fi
          echo "âœ… Version format is valid"

      - name: ðŸ” Check if tag exists
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âœ… Tag $VERSION exists"
          else
            echo "âš ï¸ Tag $VERSION does not exist yet"
          fi

  # ==========================================
  # JOB 2: Run Tests
  # ==========================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.component }}/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./${{ matrix.component }}
        run: npm ci

      - name: ðŸ§ª Run tests
        working-directory: ./${{ matrix.component }}
        run: npm test

  # ==========================================
  # JOB 3: Build and Push Docker Images
  # ==========================================
  build-docker:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [validate, test]
    
    strategy:
      matrix:
        include:
          - component: backend
            image: crud-backend
          - component: frontend
            image: crud-frontend
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“ Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/${{ matrix.image }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate.outputs.version }}
            type=raw,value=latest
            type=raw,value=stable

      - name: ðŸ³ Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.component }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.validate.outputs.version_name }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_USERNAME }}/${{ matrix.image }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_USERNAME }}/${{ matrix.image }}:buildcache,mode=max

      - name: ðŸ“Š Image summary
        run: |
          echo "## ðŸ³ Docker Image: ${{ matrix.component }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags pushed:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # JOB 4: Generate Changelog
  # ==========================================
  changelog:
    name: ðŸ“ Generate Changelog
    runs-on: ubuntu-latest
    needs: validate
    
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: |
            {
              "template": "## ðŸš€ What's Changed\n\n#{{CHANGELOG}}\n\n## ðŸ“¦ Docker Images\n\n- Backend: `${{ env.DOCKER_USERNAME }}/crud-backend:${{ needs.validate.outputs.version_name }}`\n- Frontend: `${{ env.DOCKER_USERNAME }}/crud-frontend:${{ needs.validate.outputs.version_name }}`\n\n## ðŸ”— Full Changelog\n\n**Full Changelog**: #{{RELEASE_DIFF}}",
              "categories": [
                {
                  "title": "## ðŸš€ Features",
                  "labels": ["feature", "feat", "enhancement"]
                },
                {
                  "title": "## ðŸ› Bug Fixes",
                  "labels": ["bug", "fix", "bugfix"]
                },
                {
                  "title": "## ðŸ“š Documentation",
                  "labels": ["docs", "documentation"]
                },
                {
                  "title": "## ðŸ”§ Maintenance",
                  "labels": ["chore", "refactor", "style", "ci", "cd"]
                },
                {
                  "title": "## â¬†ï¸ Dependencies",
                  "labels": ["dependencies", "deps"]
                }
              ],
              "label_extractor": [
                {
                  "pattern": "^(feat|feature)(\\(.+\\))?:",
                  "target": "feature"
                },
                {
                  "pattern": "^(fix|bugfix)(\\(.+\\))?:",
                  "target": "bug"
                },
                {
                  "pattern": "^docs(\\(.+\\))?:",
                  "target": "docs"
                },
                {
                  "pattern": "^(chore|refactor|style|ci|cd)(\\(.+\\))?:",
                  "target": "chore"
                }
              ]
            }
          toTag: ${{ needs.validate.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # JOB 5: Create GitHub Release
  # ==========================================
  release:
    name: ðŸŽ‰ Create Release
    runs-on: ubuntu-latest
    needs: [validate, test, build-docker, changelog]
    permissions:
        contents: write
        packages: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body: ${{ needs.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Release summary
        run: |
          echo "## ðŸŽ‰ Release ${{ needs.validate.outputs.version }} Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Backend" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_USERNAME }}/crud-backend:${{ needs.validate.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Frontend" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_USERNAME }}/crud-frontend:${{ needs.validate.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub Backend](https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/crud-backend)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub Frontend](https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/crud-frontend)" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # JOB 6: Notify
  # ==========================================
  notify:
    name: ðŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [validate, release]
    if: success()
    
    steps:
      - name: ðŸ“¢ Create announcement
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.validate.outputs.version }}';
            const message = `ðŸŽ‰ **New Release: ${version}**
            
            A new version has been released and is now available!
            
            ðŸ“¦ **Docker Images:**
            - Backend: \`${{ env.DOCKER_USERNAME }}/crud-backend:${{ needs.validate.outputs.version_name }}\`
            - Frontend: \`${{ env.DOCKER_USERNAME }}/crud-frontend:${{ needs.validate.outputs.version_name }}\`
            
            ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${version})`;
            
            // Create a discussion (if enabled) or issue
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Release ${version}`,
                body: message,
                labels: ['release', 'announcement']
              });
            } catch (error) {
              console.log('Could not create issue:', error.message);
            }
        continue-on-error: true