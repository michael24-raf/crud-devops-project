name: CI-CD-Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/crud-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/crud-frontend
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # JOB 1: Lint & Test Backend
  # ==========================================
  test-backend:
    name: ğŸ”¨ Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ” Lint code
        working-directory: ./backend
        run: npx eslint . --ext .js

      - name: ğŸ§ª Run tests
        working-directory: ./backend
        run: npm test

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        if: success()
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
        continue-on-error: true

  # ==========================================
  # JOB 2: Lint & Test Frontend
  # ==========================================
  test-frontend:
    name: ğŸ¨ Test Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” Lint code
        working-directory: ./frontend
        run: npm run lint || echo "No lint script found"

      - name: ğŸ—ï¸ Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: http://localhost:5000/api

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # ==========================================
  # JOB 3: Build & Push Backend Image
  # ==========================================
  build-backend:
    name: ğŸ³ Build Backend
    runs-on: ubuntu-latest
    needs: [test-backend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

  # ==========================================
  # JOB 4: Build & Push Frontend Image
  # ==========================================
  build-frontend:
    name: ğŸ¨ Build Frontend
    runs-on: ubuntu-latest
    needs: [test-frontend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          build-args: |
            VITE_API_URL=http://localhost:5000/api
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache,mode=max

  # ==========================================
  # JOB 5: Deploy to Kubernetes
  # ==========================================
  deploy-k8s:
    name: â˜¸ï¸ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          cpus: 2
          memory: 4096
          kubernetes-version: v1.28.0

      - name: â˜¸ï¸ Verify Kubernetes cluster
        run: |
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes

      - name: ğŸ“ Replace Docker Hub username in manifests
        run: |
          sed -i "s|TON_USERNAME_DOCKERHUB|${{ secrets.DOCKER_USERNAME }}|g" k8s/base/backend-deployment.yaml
          sed -i "s|TON_USERNAME_DOCKERHUB|${{ secrets.DOCKER_USERNAME }}|g" k8s/base/frontend-deployment.yaml

      - name: ğŸ—‚ï¸ Create namespace
        run: |
          kubectl apply -f k8s/base/namespace.yaml

      - name: ğŸ” Create secrets and configmaps
        run: |
          kubectl apply -f k8s/base/postgres-secret.yaml
          kubectl apply -f k8s/base/postgres-configmap.yaml
          kubectl apply -f k8s/base/backend-configmap.yaml

      - name: ğŸ’¾ Create PVC
        run: |
          kubectl apply -f k8s/base/postgres-pvc.yaml

      - name: ğŸ˜ Deploy PostgreSQL
        run: |
          kubectl apply -f k8s/base/postgres-deployment.yaml
          kubectl apply -f k8s/base/postgres-service.yaml
          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n crud-app --timeout=180s

      - name: ğŸ”¨ Deploy Backend
        run: |
          kubectl apply -f k8s/base/backend-deployment.yaml
          kubectl apply -f k8s/base/backend-service.yaml
          echo "â³ Waiting for Backend to be ready..."
          kubectl wait --for=condition=ready pod -l app=backend -n crud-app --timeout=180s

      - name: ğŸ¨ Deploy Frontend
        run: |
          kubectl apply -f k8s/base/frontend-deployment.yaml
          kubectl apply -f k8s/base/frontend-service.yaml
          echo "â³ Waiting for Frontend to be ready..."
          kubectl wait --for=condition=ready pod -l app=frontend -n crud-app --timeout=180s

      - name: âœ… Verify deployment
        run: |
          echo "==================================="
          echo "ğŸ“Š Deployment Status"
          echo "==================================="
          kubectl get all -n crud-app
          echo ""
          echo "==================================="
          echo "ğŸ” Pod Details"
          echo "==================================="
          kubectl get pods -n crud-app -o wide
          echo ""
          echo "==================================="
          echo "ğŸ“ Recent Events"
          echo "==================================="
          kubectl get events -n crud-app --sort-by='.lastTimestamp' | tail -10

      - name: ğŸ§ª Health check
        run: |
          echo "Testing backend health endpoint..."
          kubectl port-forward -n crud-app service/backend-service 5000:5000 &
          sleep 10
          
          # Test health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health)
          if [ "$response" -eq 200 ]; then
            echo "âœ… Backend health check passed!"
          else
            echo "âŒ Backend health check failed with status: $response"
            exit 1
          fi

      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "======================================"
          echo "Backend Image: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}"
          echo "Frontend Image: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "======================================"

      - name: ğŸ’¬ Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ Deployment preview available!\n\nBackend: `${{ env.BACKEND_IMAGE }}:${{ github.sha }}`\nFrontend: `${{ env.FRONTEND_IMAGE }}:${{ github.sha }}`'
            })