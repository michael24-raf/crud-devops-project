name: Deploy-Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: 'Image version/tag to deploy'
        required: true
        default: 'latest'

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  NAMESPACE: crud-app

jobs:
  
  build-and-push:
    name: ğŸ³ Build & Push Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build & push backend image
        run: |
          docker build -t ${{ env.DOCKER_USERNAME }}/crud-backend:${{ github.event.inputs.version }} ./backend
          docker push ${{ env.DOCKER_USERNAME }}/crud-backend:${{ github.event.inputs.version }}

      - name: ğŸ—ï¸ Build & push frontend image
        run: |
          docker build -t ${{ env.DOCKER_USERNAME }}/crud-frontend:${{ github.event.inputs.version }} ./frontend
          docker push ${{ env.DOCKER_USERNAME }}/crud-frontend:${{ github.event.inputs.version }}


  deploy:
    name: ğŸš€ Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          cpus: 2
          memory: 4096

      - name: â˜¸ï¸ Configure kubectl
        run: |
          kubectl version --client
          kubectl cluster-info

      - name: ğŸ“ Update manifests
        run: |
          sed -i "s|TON_USERNAME_DOCKERHUB|${{ env.DOCKER_USERNAME }}|g" k8s/base/backend-deployment.yaml
          sed -i "s|TON_USERNAME_DOCKERHUB|${{ env.DOCKER_USERNAME }}|g" k8s/base/frontend-deployment.yaml
          sed -i "s|:latest|:${{ github.event.inputs.version }}|g" k8s/base/backend-deployment.yaml
          sed -i "s|:latest|:${{ github.event.inputs.version }}|g" k8s/base/frontend-deployment.yaml

      - name: ğŸš€ Deploy application
        run: |
          # Apply all manifests
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/postgres-secret.yaml
          kubectl apply -f k8s/base/postgres-configmap.yaml
          kubectl apply -f k8s/base/backend-configmap.yaml
          kubectl apply -f k8s/base/postgres-pvc.yaml
          kubectl apply -f k8s/base/postgres-deployment.yaml
          kubectl apply -f k8s/base/postgres-service.yaml
          
          kubectl wait --for=condition=ready pod -l app=postgres -n ${{ env.NAMESPACE }} --timeout=180s
          
          kubectl apply -f k8s/base/backend-deployment.yaml
          kubectl apply -f k8s/base/backend-service.yaml
          
          kubectl wait --for=condition=ready pod -l app=backend -n ${{ env.NAMESPACE }} --timeout=180s
          
          kubectl apply -f k8s/base/frontend-deployment.yaml
          kubectl apply -f k8s/base/frontend-service.yaml
          
          kubectl wait --for=condition=ready pod -l app=frontend -n ${{ env.NAMESPACE }} --timeout=180s

      - name: âœ… Verify deployment
        run: |
          kubectl get all -n ${{ env.NAMESPACE }}
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

      - name: ğŸ“Š Deployment info
        run: |
          echo "âœ… Deployment successful!"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Namespace: ${{ env.NAMESPACE }}"