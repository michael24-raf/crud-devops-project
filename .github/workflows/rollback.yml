name: Rollback

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to rollback'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - all
      version:
        description: 'Docker image version to deploy'
        required: true
        default: 'latest'
      environment:
        description: 'Environment'
        required: true
        type: choice
        default: 'development'
        options:
          - development
          - staging
          - production

env:
  NAMESPACE: crud-app
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  rollback:
    name: ğŸ”„ Rollback ${{ github.event.inputs.service }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          cpus: 2
          memory: 4096

      - name: â˜¸ï¸ Verify Kubernetes cluster
        run: |
          kubectl version --client
          kubectl cluster-info

      # ğŸ”¹ IMPORTANT : crÃ©er le namespace (Minikube est vide)
      - name: ğŸ—ï¸ Ensure namespace exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      # ğŸ”¹ Appliquer les ressources de base (obligatoire)
      - name: ğŸ“¦ Apply base manifests
        run: |
          kubectl apply -f k8s/base/postgres-secret.yaml
          kubectl apply -f k8s/base/postgres-configmap.yaml
          kubectl apply -f k8s/base/backend-configmap.yaml
          kubectl apply -f k8s/base/postgres-pvc.yaml
          kubectl apply -f k8s/base/postgres-deployment.yaml
          kubectl apply -f k8s/base/postgres-service.yaml

      - name: â³ Wait for Postgres
        run: |
          kubectl wait --for=condition=ready pod \
            -l app=postgres \
            -n ${{ env.NAMESPACE }} \
            --timeout=180s

      # ğŸ”¹ Rollback Backend = redeploy image
      - name: ğŸ”„ Rollback Backend
        if: github.event.inputs.service == 'backend' || github.event.inputs.service == 'all'
        run: |
          kubectl apply -f k8s/base/backend-deployment.yaml
          kubectl set image deployment/backend-deployment \
            backend=${{ env.DOCKER_USERNAME }}/crud-backend:${{ github.event.inputs.version }} \
            -n ${{ env.NAMESPACE }}

          kubectl rollout status deployment/backend-deployment \
            -n ${{ env.NAMESPACE }} --timeout=180s

      # ğŸ”¹ Rollback Frontend = redeploy image
      - name: ğŸ”„ Rollback Frontend
        if: github.event.inputs.service == 'frontend' || github.event.inputs.service == 'all'
        run: |
          kubectl apply -f k8s/base/frontend-deployment.yaml
          kubectl set image deployment/frontend-deployment \
            frontend=${{ env.DOCKER_USERNAME }}/crud-frontend:${{ github.event.inputs.version }} \
            -n ${{ env.NAMESPACE }}

          kubectl rollout status deployment/frontend-deployment \
            -n ${{ env.NAMESPACE }} --timeout=180s

      - name: âœ… Verify rollback
        run: |
          echo "=============================="
          echo "ğŸ“¦ Rollback status"
          echo "=============================="
          kubectl get deployments -n ${{ env.NAMESPACE }}
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

      - name: ğŸ“ Rollback summary
        run: |
          echo "âœ… Rollback completed successfully"
          echo "Service     : ${{ github.event.inputs.service }}"
          echo "Version     : ${{ github.event.inputs.version }}"
          echo "Environment : ${{ github.event.inputs.environment }}"
          echo "Namespace   : ${{ env.NAMESPACE }}"
