name: Security-Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  workflow_dispatch:  # Manual trigger

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

jobs:
  # ==========================================
  # JOB 1: Dependency Vulnerability Scan
  # ==========================================
  dependency-scan:
    name: ğŸ” Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ“¦ Install Frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” Audit Backend dependencies
        working-directory: ./backend
        run: |
          npm audit --json > backend-audit.json || true
          npm audit --audit-level=high
        continue-on-error: true

      - name: ğŸ” Audit Frontend dependencies
        working-directory: ./frontend
        run: |
          npm audit --json > frontend-audit.json || true
          npm audit --audit-level=high
        continue-on-error: true

      - name: ğŸ“¤ Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: |
            backend/backend-audit.json
            frontend/frontend-audit.json
          retention-days: 30

      # Optional: Snyk scan (requires SNYK_TOKEN secret)
      - name: ğŸ” Snyk scan - Backend
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=backend/package.json
        continue-on-error: true

      - name: ğŸ” Snyk scan - Frontend
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=frontend/package.json
        continue-on-error: true

  # ==========================================
  # JOB 2: Docker Image Security Scan
  # ==========================================
  docker-scan:
    name: ğŸ³ Docker Image Scan
    runs-on: ubuntu-latest

    permissions:
        contents: read
        security-events: write
    
    strategy:
      matrix:
        service: [backend, frontend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Build ${{ matrix.service }} image
        run: |
          docker build -t ${{ matrix.service }}-scan:latest ./${{ matrix.service }}

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}-scan:latest
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'  # Don't fail the build
          ignore-unfixed: true

      - name: ğŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}-results.sarif'
          category: trivy-${{ matrix.service }}

      - name: ğŸ” Run Trivy scan (table format for logs)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}-scan:latest
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“Š Generate vulnerability report
        if: always()
        run: |
          echo "## ğŸ” Security Scan Results - ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy:latest image --severity CRITICAL,HIGH --format json ${{ matrix.service }}-scan:latest | \
            jq -r '.Results[] | select(.Vulnerabilities) | .Vulnerabilities[] | "- \(.VulnerabilityID): \(.Title) (Severity: \(.Severity))"' >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # JOB 3: Code Security Analysis (CodeQL)
  # ==========================================
  code-scan:
    name: ğŸ”’ Code Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{ matrix.language }}"

  # ==========================================
  # JOB 4: Secret Detection
  # ==========================================
  secret-scan:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: ğŸ” TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ” GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ==========================================
  # JOB 5: YAML & Dockerfile Linting
  # ==========================================
  lint-configs:
    name: ğŸ” Configuration Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Lint Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: backend/Dockerfile
          failure-threshold: warning
        continue-on-error: true

      - name: ğŸ” Lint Frontend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: frontend/Dockerfile
          failure-threshold: warning
        continue-on-error: true

      - name: ğŸ” Lint Kubernetes manifests
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          find k8s/base -name "*.yaml" -exec kubeval {} \;

      - name: ğŸ” Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: k8s/
          config_file: .yamllint.yml
          strict: false
        continue-on-error: true

  # ==========================================
  # JOB 6: OWASP Dependency Check
  # ==========================================
  owasp-scan:
    name: ğŸ›¡ï¸ OWASP Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: ğŸ›¡ï¸ OWASP Dependency-Check Backend
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'crud-backend'
          path: './backend'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired
        continue-on-error: true

      - name: ğŸ›¡ï¸ OWASP Dependency-Check Frontend
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'crud-frontend'
          path: './frontend'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired
        continue-on-error: true

      - name: ğŸ“¤ Upload OWASP reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: owasp-reports
          path: reports/
          retention-days: 30

  # ==========================================
  # JOB 7: Security Summary
  # ==========================================
  security-summary:
    name: ğŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, docker-scan, code-scan, secret-scan, lint-configs]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate security summary
        run: |
          echo "## ğŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Docker Image Scan | ${{ needs.docker-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Code Security Scan | ${{ needs.code-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Secret Detection | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Configuration Linting | ${{ needs.lint-configs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations:" >> $GITHUB_STEP_SUMMARY
          echo "- Review all HIGH and CRITICAL vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Update dependencies with known vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Check Docker images for outdated base images" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure no secrets are committed to the repository" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ”’ Security Scan Results

            | Scan Type | Status |
            |-----------|--------|
            | ğŸ“¦ Dependency Scan | ${{ needs.dependency-scan.result }} |
            | ğŸ³ Docker Image Scan | ${{ needs.docker-scan.result }} |
            | ğŸ”’ Code Security Scan | ${{ needs.code-scan.result }} |
            | ğŸ” Secret Detection | ${{ needs.secret-scan.result }} |
            | ğŸ” Configuration Linting | ${{ needs.lint-configs.result }} |

            Please review the security scan results in the Actions tab.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
